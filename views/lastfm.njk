{% extends "layouts/lastfm.njk" %}

{% block lastfm %}
  {# Settings Section #}
  {% call section({ title: __("lastfm.settings") }) %}
    <p class="hint">{{ __("lastfm.settingsHelp") }}</p>
    <form method="post" action="{{ mountPath }}/settings" class="lastfm-form">
      <div class="lastfm-field">
        <label class="label" for="apiKey">{{ __("lastfm.apiKey") }}</label>
        <span class="hint" id="apiKey-hint">{{ __("lastfm.apiKeyHelp") }}</span>
        <input class="input" type="password" id="apiKey" name="apiKey" value="{{ settings.apiKey }}" aria-describedby="apiKey-hint" placeholder="Your Last.fm API key" autocomplete="off">
      </div>
      <div class="lastfm-field">
        <label class="label" for="username">{{ __("lastfm.username") }}</label>
        <span class="hint" id="username-hint">{{ __("lastfm.usernameHelp") }}</span>
        <input class="input" type="text" id="username" name="username" value="{{ settings.username }}" aria-describedby="username-hint" placeholder="Last.fm username">
      </div>
      <div>
        {{ button({
          type: "submit",
          text: __("lastfm.saveSettings")
        }) }}
      </div>
    </form>
  {% endcall %}

  {% if not configError %}
    {# Now Playing / Recently Played #}
    {% if nowPlaying %}
    {% call section({ title: nowPlaying.status == "now-playing" and __("lastfm.nowPlaying") or __("lastfm.recentlyPlayed") }) %}
      {% if nowPlaying.status == "now-playing" %}
      <p class="lastfm-playing">
        <span class="lastfm-bars">
          <span></span><span></span><span></span>
        </span>
        {{ __("lastfm.nowPlaying") }}
      </p>
      {% endif %}
      <article class="lastfm-featured">
        {% if nowPlaying.coverUrl %}
        <img src="{{ nowPlaying.coverUrl }}" alt="" loading="lazy">
        {% endif %}
        <div class="lastfm-featured__info">
          <a href="{{ nowPlaying.trackUrl }}" class="lastfm-featured__title" target="_blank" rel="noopener">
            {{ nowPlaying.artist }} - {{ nowPlaying.track }}
          </a>
          {% if nowPlaying.album %}
          <p class="lastfm-featured__album">{{ nowPlaying.album }}</p>
          {% endif %}
          <small class="lastfm-meta">
            {% if nowPlaying.loved %}<span class="lastfm-loved">&#9829;</span>{% endif %}
            <span>{{ nowPlaying.relativeTime }}</span>
          </small>
        </div>
      </article>
    {% endcall %}
    {% endif %}

    {# Quick Stats #}
    {% if hasStats %}
    {% call section({ title: __("lastfm.stats") }) %}
      <div class="lastfm-stats">
        <div class="lastfm-stat">
          <span class="lastfm-stat__value">{{ totalPlays }}</span>
          <span class="lastfm-stat__label">{{ __("lastfm.plays") }}</span>
        </div>
        <div class="lastfm-stat">
          <span class="lastfm-stat__value">{{ uniqueTracks }}</span>
          <span class="lastfm-stat__label">{{ __("lastfm.tracks") }}</span>
        </div>
        <div class="lastfm-stat">
          <span class="lastfm-stat__value">{{ uniqueArtists }}</span>
          <span class="lastfm-stat__label">{{ __("lastfm.artists") }}</span>
        </div>
      </div>
    {% endcall %}
    {% endif %}

    {# Recent Scrobbles #}
    {% if scrobbles and scrobbles.length > 0 %}
    {% call section({ title: __("lastfm.scrobbles") }) %}
      <ul class="lastfm-list">
        {% for scrobble in scrobbles %}
        <li class="lastfm-list__item">
          {% if scrobble.coverUrl %}
          <img src="{{ scrobble.coverUrl }}" alt="" loading="lazy">
          {% else %}
          <div class="lastfm-list__placeholder"></div>
          {% endif %}
          <div class="lastfm-list__info">
            <a href="{{ scrobble.trackUrl }}" class="lastfm-list__title" target="_blank" rel="noopener">
              {{ scrobble.artist }} - {{ scrobble.track }}
            </a>
            <small class="lastfm-meta">
              {% if scrobble.loved %}<span class="lastfm-loved">&#9829;</span>{% endif %}
              {{ scrobble.relativeTime }}
            </small>
          </div>
        </li>
        {% endfor %}
      </ul>
    {% endcall %}
    {% endif %}

    {# Loved Tracks #}
    {% if lovedTracks and lovedTracks.length > 0 %}
    {% call section({ title: __("lastfm.loved") }) %}
      <ul class="lastfm-list">
        {% for track in lovedTracks %}
        <li class="lastfm-list__item">
          {% if track.coverUrl %}
          <img src="{{ track.coverUrl }}" alt="" loading="lazy">
          {% else %}
          <div class="lastfm-list__placeholder"></div>
          {% endif %}
          <div class="lastfm-list__info">
            <a href="{{ track.trackUrl }}" class="lastfm-list__title" target="_blank" rel="noopener">
              {{ track.artist }} - {{ track.track }}
            </a>
            <small class="lastfm-meta">
              <span class="lastfm-loved">&#9829;</span>
              {{ track.relativeTime }}
            </small>
          </div>
        </li>
        {% endfor %}
      </ul>
    {% endcall %}
    {% endif %}

    {# Actions #}
    {% call section({ title: __("lastfm.actions") }) %}
      <form method="post" action="{{ mountPath }}/sync">
        {{ button({
          type: "submit",
          text: __("lastfm.sync")
        }) }}
      </form>
    {% endcall %}

    {# Public Page Link #}
    {% if publicUrl %}
    {% call section({ title: __("lastfm.widget.title") if __("lastfm.widget.title") else "Public page" }) %}
      <div class="lastfm-public-link">
        <p>{{ __("lastfm.widget.description") }}</p>
        {{ button({
          classes: "button--secondary",
          href: publicUrl,
          text: __("lastfm.widget.view"),
          target: "_blank"
        }) }}
      </div>
    {% endcall %}
    {% endif %}
  {% endif %}
{% endblock %}
